import{j as e,U as ye,L as we,aA as Ce,T as r,B as H,l as fe,I as te,aB as Pe,c as ke,n as k,S as Ie,v as $e,V as ee,w as Q,k as _,D as ne,f as re,h as le,m as oe,t as Y,u as Se,o as Ae}from"./index-B1pDaH9M.js";import{r as d,R as De,f as Me,u as He}from"./react-vendor-3Ywg6HeR.js";import{T as ce,U as X}from"./combobox-C_4wLuUN.js";import{M as ve}from"./MarkdownContent-D1FiwppT.js";import{A as Te}from"./AssetViewerDialog-DHbwSvdx.js";import"./map-vendor-Bbrwb_BN.js";import"./utilities-BiTQLgRB.js";import"./useHover-MM8zNcZl.js";import"./PDFViewer-C_W6cl_T.js";const Ee=({orientation:s="horizontal",className:v="",sx:w={}})=>{const m={};w.my&&(m.margin=`${w.my*.25}rem 0`),w.mx&&(m.margin=`0 ${w.mx*.25}rem`),w.m&&(m.margin=`${w.m*.25}rem`);const t=s==="horizontal"?"w-full border-t":"h-full border-l";return e.jsx("hr",{className:`
        border-slate-700/30
        ${t}
        ${v}
      `,style:m})},Le=({content:s,color:v="primary",className:w=""})=>e.jsx("div",{className:`relative inline-flex items-center ${w}`,children:e.jsx("span",{className:`absolute -top-2 -right-2 flex items-center justify-center w-5 h-5 text-xs text-white rounded-full ${v==="primary"?"bg-blue-500":"bg-red-500"}`,children:s})}),Re=({participants:s,currentTurnIndex:v,selectedParticipantId:w,onSelectParticipant:m})=>e.jsx(ye,{className:"w-full max-h-[60vh] overflow-auto","data-testid":"participant-list",children:s.map((t,U)=>{const O=U===v,b=t.id===w,g=t.character.name.replace(/\s+/g,"-");return e.jsx(we,{"data-testid":`participant-item-${g}`,className:`
              mb-2 rounded-lg transition-all duration-200
              ${O?"bg-blue-100 dark:bg-blue-900/30":""}
              ${b?"border-2 border-blue-500":"border border-gray-200 dark:border-gray-700"}
              ${t.isDefeated?"opacity-50":""}
              cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-800
            `,onClick:()=>m(t.id),children:e.jsxs("div",{className:"flex items-center w-full",children:[e.jsxs("div",{className:"relative mr-3",children:[e.jsx(Ce,{src:t.character.descriptionAssetName||void 0,alt:t.character.name,className:`
                    ${t.isPlayerCharacter?"bg-green-100":"bg-red-100"}
                    ${t.isDefeated?"grayscale":""}
                  `,children:!t.character.descriptionAssetName&&t.character.name.charAt(0)}),e.jsx(Le,{content:t.initiative,color:t.isPlayerCharacter?"primary":"error"})]}),e.jsxs("div",{className:"flex-grow",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs(r,{variant:"subtitle1",className:"font-semibold",children:[t.character.name,O&&e.jsx("span",{className:"ml-2 text-xs font-normal text-blue-600 dark:text-blue-400",children:"(Current Turn)"})]}),e.jsx(H,{children:e.jsx(fe,{label:`${t.currentHp}/${t.maxHp} HP`,color:t.isDefeated?"error":t.currentHp/t.maxHp<.3?"warning":"success",size:"small",variant:"outlined"})})]}),e.jsxs(r,{variant:"body2",className:"text-gray-600 dark:text-gray-300 truncate",children:[t.character.type," â€¢ ",t.isPlayerCharacter?"Player":"NPC",t.isDefeated&&e.jsx("span",{className:"ml-2 text-red-500",children:"Defeated"})]})]})]})},t.id)})}),Oe=({participant:s,onUpdateHp:v,onUpdateNotes:w,onRemoveParticipant:m,onUpdateInitiative:t,isEditing:U,onSetEditing:O,onViewDescription:b})=>{var j;const[g,S]=d.useState(s.currentHp),[x,I]=d.useState(s.initiative),[h,A]=d.useState(s.notes||""),M=s.isDefeated,{character:y}=s,B=y.descriptionAssetName&&(y.descriptionType==="pdf"||y.descriptionType==="image");d.useEffect(()=>{S(s.currentHp),I(s.initiative),A(s.notes||"")},[s]);const i=()=>{v(s.id,g),t(s.id,x),w(s.id,h),O(!1)},C=()=>{S(s.currentHp),I(s.initiative),A(s.notes||""),O(!1)};return e.jsxs("div",{className:"h-full flex flex-col overflow-auto p-3",children:[e.jsxs("div",{className:"flex justify-between items-center mb-3",children:[e.jsxs("div",{className:"flex items-center",children:[e.jsxs("h2",{className:`font-display text-base font-semibold ${M?"line-through text-red-500":""}`,children:[y.name,y.type&&e.jsxs("span",{className:"ml-2 text-xs opacity-70",children:["(",y.type,")"]})]}),e.jsxs("div",{className:"flex ml-2",children:[B&&b&&e.jsx(ce,{title:`View ${((j=y.descriptionType)==null?void 0:j.toUpperCase())||"Document"}`,placement:"top",children:e.jsx(te,{onClick:b,"aria-label":`View ${y.descriptionType||"document"}`,className:"text-primary-light mr-1",children:e.jsx(Pe,{className:"w-4 h-4"})})}),!U&&e.jsx(te,{onClick:()=>O(!0),"aria-label":"Edit",children:e.jsx(ke,{className:"w-4 h-4"})})]})]}),e.jsx("div",{className:"flex items-center",children:U?e.jsxs(e.Fragment,{children:[e.jsx(k,{variant:"text",color:"error",onPress:C,className:"text-xs mr-2",children:"Cancel"}),e.jsx(k,{variant:"contained",color:"primary",onPress:i,className:"text-xs",startIcon:e.jsx(Ie,{className:"w-3 h-3"}),children:"Save"})]}):e.jsxs(e.Fragment,{children:[B&&b&&e.jsxs(k,{variant:"outlined",color:"primary",onPress:b,className:"text-xs mr-2",children:["View ",y.descriptionType==="pdf"?"PDF":"Image"]}),e.jsx(k,{variant:"outlined",color:"error",onPress:()=>m(s.id),className:"text-xs",startIcon:e.jsx($e,{className:"w-3 h-3"}),children:"Remove"})]})})]}),e.jsxs(ee,{container:!0,spacing:2,className:"mb-4",children:[e.jsx(ee,{item:!0,xs:4,children:e.jsxs(Q,{className:"p-3 h-full",children:[e.jsx(r,{variant:"subtitle2",className:"font-semibold mb-1",children:"HP"}),U?e.jsx(_,{value:g.toString(),onChange:$=>S(parseInt($.target.value)||0),onBlur:()=>v(s.id,g),type:"number",size:"small",fullWidth:!0}):e.jsxs("div",{className:"flex items-baseline",children:[e.jsx("span",{className:`text-lg font-bold ${s.currentHp<=0?"text-red-500":""}`,children:s.currentHp}),e.jsxs("span",{className:"text-xs opacity-60 ml-1",children:["/ ",s.maxHp]})]})]})}),e.jsx(ee,{item:!0,xs:4,children:e.jsxs(Q,{className:"p-3 h-full",children:[e.jsx(r,{variant:"subtitle2",className:"font-semibold mb-1",children:"Initiative"}),U?e.jsx(_,{value:x.toString(),onChange:$=>I(parseInt($.target.value)||0),onBlur:()=>t(s.id,x),type:"number",size:"small",fullWidth:!0}):e.jsx("span",{className:"text-lg font-bold",children:s.initiative})]})}),e.jsx(ee,{item:!0,xs:4,children:e.jsxs(Q,{className:"p-3 h-full",children:[e.jsx(r,{variant:"subtitle2",className:"font-semibold mb-1",children:"Type"}),e.jsx("span",{className:"text-base",children:s.isPlayerCharacter?"PC":"NPC"})]})})]}),e.jsxs("div",{className:"flex-grow overflow-auto",children:[e.jsxs(Q,{className:"p-4 mb-4",children:[e.jsx(r,{variant:"subtitle2",className:"font-semibold mb-2",children:"Notes"}),U?e.jsx(_,{value:h,onChange:$=>{A($.target.value),w(s.id,$.target.value)},fullWidth:!0,InputProps:{inputProps:{style:{minHeight:"100px"}}}}):e.jsx("div",{className:"text-sm whitespace-pre-wrap",children:s.notes||e.jsx("span",{className:"opacity-50 italic",children:"No notes"})})]}),y.description&&e.jsxs(Q,{className:"p-4",children:[e.jsxs("div",{className:"flex justify-between items-center mb-2",children:[e.jsx(r,{variant:"subtitle2",className:"font-semibold",children:"Description"}),b&&e.jsx(k,{size:"small",variant:"outlined",color:"primary",className:"text-xs",onPress:b,children:"View full description"})]}),e.jsx("div",{className:"description-preview max-h-48 overflow-y-auto",children:e.jsx(ve,{content:y.description})})]})]})]})},Ue=({open:s,onClose:v,onAddParticipant:w,characters:m})=>{const[t,U]=d.useState(""),[O,b]=d.useState(""),[g,S]=d.useState(null),x=De.useMemo(()=>{const i={player:[],enemy:[],npc:[],other:[]};return m.forEach(C=>{const j=C.type||"other";i[j]?i[j].push(C):i.other.push(C)}),i},[m]),I=O?m.filter(i=>i.name.toLowerCase().includes(O.toLowerCase())):m;d.useEffect(()=>{if(t){const i=m.find(C=>C.id===t);S(i||null)}else S(null)},[t,m]);const h=()=>{if(!t||!g)return;const i=g.type==="player";w(t,0,i),A(),v()},A=()=>{U(""),b(""),S(null)},M=()=>{A(),v()},y=i=>{U(i||"")},B=(i,C)=>C.length?e.jsxs("div",{className:"mb-2",children:[e.jsx(r,{variant:"subtitle2",className:"text-xs font-semibold uppercase text-text-secondary px-3 py-1",children:i}),C.map(j=>e.jsx(X.Option,{value:j.id,className:({active:$})=>`cursor-pointer select-none relative py-2 pl-3 pr-9 ${$?"bg-blue-100 dark:bg-blue-900/40":""}`,children:({selected:$,active:W})=>e.jsxs(H,{className:`flex items-center ${$?"font-semibold":""}`,children:[e.jsx(H,{className:`w-3 h-3 rounded-full mr-2 ${j.type==="player"?"bg-green-500":j.type==="enemy"?"bg-red-500":"bg-yellow-500"}`}),e.jsx("span",{className:W?"text-blue-700 dark:text-blue-300":"",children:j.name}),e.jsx("span",{className:"ml-2 text-xs text-gray-500 dark:text-gray-400",children:j.type}),$&&e.jsx("span",{className:"absolute inset-y-0 right-0 flex items-center pr-3",children:e.jsx("svg",{className:"h-5 w-5 text-primary",viewBox:"0 0 20 20",fill:"currentColor",children:e.jsx("path",{fillRule:"evenodd",clipRule:"evenodd",d:"M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z"})})})]})},j.id))]}):null;return e.jsxs(ne,{open:s,onClose:M,fullWidth:!0,maxWidth:"sm",children:[e.jsx(re,{children:e.jsx(r,{variant:"h6",className:"font-display",children:"Add Combat Participant"})}),e.jsxs(le,{children:[e.jsxs("div",{className:"mb-4",children:[e.jsx(r,{variant:"body2",className:"mb-2",children:"Select a character to add to the combat:"}),e.jsx(X,{value:t,onChange:y,children:e.jsxs("div",{className:"relative",children:[e.jsxs("div",{className:"flex items-center border border-gray-300 dark:border-gray-700 rounded-md p-2",children:[e.jsx(X.Input,{className:"w-full bg-transparent border-none focus:outline-none dark:text-white",placeholder:"Search for a character...",displayValue:i=>{const C=m.find(j=>j.id===i);return C?C.name:""},onChange:i=>b(i.target.value)}),e.jsx("svg",{className:"h-5 w-5 text-gray-400",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"})})]}),e.jsx(X.Options,{className:"absolute z-10 mt-1 w-full bg-white dark:bg-gray-800 shadow-lg max-h-60 rounded-md py-1 text-base overflow-auto",children:O?I.length>0?I.map(i=>e.jsx(X.Option,{value:i.id,className:({active:C})=>`cursor-pointer select-none relative py-2 pl-3 pr-9 ${C?"bg-blue-100 dark:bg-blue-900/40":""}`,children:({selected:C,active:j})=>e.jsxs(H,{className:`flex items-center ${C?"font-semibold":""}`,children:[e.jsx(H,{className:`w-3 h-3 rounded-full mr-2 ${i.type==="player"?"bg-green-500":i.type==="enemy"?"bg-red-500":"bg-yellow-500"}`}),e.jsx("span",{className:j?"text-blue-700 dark:text-blue-300":"",children:i.name}),e.jsxs("span",{className:"ml-2 text-xs text-gray-500 dark:text-gray-400",children:["(",i.type,")"]})]})},i.id)):e.jsx("div",{className:"p-4 text-center text-gray-500",children:"No characters found"}):e.jsxs(e.Fragment,{children:[B("Player Characters",x.player),B("Enemies",x.enemy),B("NPCs",x.npc),B("Other",x.other)]})})]})})]}),g&&e.jsxs(Q,{className:"p-3 mt-4 bg-background-surface/30",children:[e.jsx(r,{variant:"subtitle1",className:"font-semibold mb-2",children:"Selected Character:"}),e.jsxs("div",{className:"flex items-center mb-2",children:[e.jsx(H,{className:`w-3 h-3 rounded-full mr-2 ${g.type==="player"?"bg-green-500":g.type==="enemy"?"bg-red-500":"bg-yellow-500"}`}),e.jsx(r,{variant:"body1",className:"font-medium",children:g.name}),e.jsxs(r,{variant:"caption",className:"ml-2 text-text-secondary",children:["(",g.type||"Character",")"]})]}),e.jsxs(r,{variant:"body2",className:"text-text-secondary",children:["HP: ",g.hp||10]})]}),e.jsx(r,{variant:"body2",className:"text-text-secondary mt-4",children:"Note: After adding, you'll be prompted to set the participant's initiative."})]}),e.jsxs(oe,{children:[e.jsx(k,{onPress:M,variant:"outlined",children:"Cancel"}),e.jsx(k,{onPress:h,variant:"contained",color:"primary",isDisabled:!t,children:"Add to Combat"})]})]})},Be=[{label:"",value:"d20",description:"1d20 (avg: 10.5)"},{label:"",value:"d12",description:"1d12 (avg: 6.5)"},{label:"",value:"d10",description:"1d10 (avg: 5.5)"},{label:"",value:"d8",description:"1d8 (avg: 4.5)"},{label:"",value:"d6",description:"1d6 (avg: 3.5)"},{label:"",value:"d4",description:"1d4 (avg: 2.5)"}],ze=({open:s,onClose:v,participants:w,onComplete:m,title:t="Set Initiative",isSingleParticipant:U=!1,onViewCharacterDetails:O})=>{const[b,g]=d.useState([]),[S,x]=d.useState(0),[I,h]=d.useState(""),[A,M]=d.useState("d20"),[y,B]=d.useState("0");d.useEffect(()=>{s&&w&&w.length>0&&(g([...w]),x(0))},[s,w]);const i=b[S],C=S===b.length-1,j=()=>{let u=0;switch(A){case"d20":u=Math.floor(Math.random()*20)+1;break;case"d12":u=Math.floor(Math.random()*12)+1;break;case"d10":u=Math.floor(Math.random()*10)+1;break;case"d8":u=Math.floor(Math.random()*8)+1;break;case"d6":u=Math.floor(Math.random()*6)+1;break;case"d4":u=Math.floor(Math.random()*4)+1;break;default:u=Math.floor(Math.random()*20)+1}const D=parseInt(y)||0;return u+=D,console.log(`Rolled initiative: ${u} (${A} + ${D})`),Math.max(1,u)},$=u=>{h(u)},W=()=>{if(!i)return;const u=I?parseInt(I):j();console.log(`Setting initiative for ${i.character.name} to ${u}`);const D=JSON.parse(JSON.stringify(b));if(D[S]={...D[S],initiative:u},g(D),h(""),C){console.log("All initiatives set:",D.map(R=>`${R.character.name}: ${R.initiative}`));const L=[...D].sort((R,z)=>z.initiative-R.initiative);m(L)}else x(S+1)},q=()=>{if(!i)return;const u=j();console.log(`Quick roll result for ${i.character.name}: ${u}`);const D=JSON.parse(JSON.stringify(b));if(D[S]={...D[S],initiative:u},g(D),C){console.log("All initiatives set:",D.map(R=>`${R.character.name}: ${R.initiative}`));const L=[...D].sort((R,z)=>z.initiative-R.initiative);m(L)}else x(S+1)},T=()=>{console.log("Rolling for all participants");const u=JSON.parse(JSON.stringify(b));u.forEach((L,R)=>{const z=j();console.log(`Rolling for ${L.character.name}: ${z}`),u[R].initiative=z});const D=[...u].sort((L,R)=>R.initiative-L.initiative);console.log("Final initiative order:",D.map(L=>`${L.character.name}: ${L.initiative}`)),m(D)},V=()=>{g([]),x(0),h(""),v()};return s&&(!b||b.length===0)?e.jsxs(ne,{open:s,onClose:V,fullWidth:!0,maxWidth:"sm",children:[e.jsx(re,{children:t}),e.jsx(le,{children:e.jsx(H,{className:"p-4 text-center",children:e.jsx(r,{children:"No participants available to set initiative."})})}),e.jsx(oe,{children:e.jsx(k,{onPress:V,children:"Close"})})]}):e.jsxs(ne,{open:s,onClose:V,fullWidth:!0,maxWidth:"sm",children:[e.jsx(re,{children:t}),e.jsx(le,{children:i?e.jsxs(H,{className:"mb-4",children:[e.jsx(r,{variant:"h6",className:"mb-2",children:U?"Set Initiative":`${S+1}/${b.length}: Set Initiative`}),e.jsxs(Q,{className:"p-4 mb-4",children:[e.jsxs(H,{className:"flex justify-between items-center mb-2",children:[e.jsxs(H,{className:"flex items-center",children:[e.jsx(r,{variant:"subtitle1",className:"font-semibold mr-2",children:i.character.name}),e.jsxs(r,{variant:"body2",className:"text-text-secondary",children:["(",i.isPlayerCharacter?"Player Character":"NPC",")"]})]}),O&&e.jsx(k,{variant:"outlined",size:"small",color:"primary",className:"text-xs",onPress:()=>O(i),children:"View Details"})]}),e.jsxs(r,{variant:"body2",className:"text-text-secondary mb-2",children:["Type: ",i.character.type||(i.isPlayerCharacter?"player":"enemy")]})]}),e.jsx(r,{variant:"subtitle2",className:"mb-2",children:"Initiative Options"}),e.jsxs(H,{className:"mb-4",children:[e.jsx(r,{variant:"body2",className:"mb-2",children:"Enter specific value:"}),e.jsxs(H,{className:"flex gap-2",children:[e.jsx(_,{value:I,onChange:$,placeholder:"Initiative value",type:"number",className:"flex-1"}),e.jsx(k,{variant:"contained",color:"primary",onPress:W,isDisabled:!I,children:"Apply"})]})]}),e.jsx(Ee,{className:"my-4"}),e.jsx(r,{variant:"body2",className:"mb-2",children:"Or roll random initiative:"}),e.jsxs(H,{className:"grid grid-cols-2 gap-4 mb-4",children:[e.jsxs(H,{children:[e.jsx(r,{variant:"caption",className:"block mb-1",children:"Dice Type"}),e.jsx("select",{value:A,onChange:u=>M(u.target.value),className:"block w-full p-2 border border-gray-300 rounded-md bg-background-input dark:bg-gray-800 dark:border-gray-700 dark:text-gray-200",children:Be.map(u=>e.jsx("option",{value:u.value,className:"dark:bg-gray-800 dark:text-white",children:u.description},u.value))})]}),e.jsxs(H,{children:[e.jsx(r,{variant:"caption",className:"block mb-1",children:"Bonus"}),e.jsx(_,{value:y,onChange:B,type:"number",className:"w-full"})]})]}),e.jsx(k,{variant:"contained",color:"primary",className:"w-full",onPress:q,children:"Roll and Continue"}),!U&&S===0&&e.jsx(H,{className:"mt-4",children:e.jsx(k,{variant:"outlined",color:"secondary",className:"w-full",onPress:T,children:"Quick Mode: Roll for All Participants and Start"})})]}):e.jsx(H,{className:"p-4 text-center",children:e.jsx(r,{children:"Loading participant data..."})})}),e.jsx(oe,{children:e.jsx(k,{onPress:V,children:"Cancel"})})]})},be=()=>{const s=Me(),v=He(),{combats:w,characters:m,isCombatAudioInitialized:t,markCombatAudioInitialized:U,resetCombatAudioInitialized:O}=Y(),{play:b,stopLocationTracks:g}=Se(),x=new URLSearchParams(v.search).get("id"),I=w.find(a=>a.id===x),[h,A]=d.useState([]),[M,y]=d.useState(0),[B,i]=d.useState(1),[C,j]=d.useState(null),[$,W]=d.useState(null),q=d.useRef(0);d.useEffect(()=>{(!x||!I)&&(console.warn("useCombatSession: No valid combat found, redirecting."),s("/combats"))},[x,I,s]),d.useEffect(()=>{if(!x)return;q.current+=1;const a=q.current;console.log(`useCombatSession AUDIO EFFECT RUN #${a} (Deps: combatId=${x})`);const o=Y.getState().combats.find(l=>l.id===x),c=Y.getState().isCombatAudioInitialized(x);if(o&&!c){Y.getState().markCombatAudioInitialized(x);const l=`combat-${o.id}`;console.log(`RUN #${a}: Initializing audio for combat ID: ${o.id}, prefix: ${l}`),o.locationId&&(console.log(`RUN #${a}: Stopping previous map location tracks for ${o.locationId}`),g(o.locationId)),o.entrySound&&(console.log(`RUN #${a}: Playing combat entry sound ${o.entrySound}`),b(o.entrySound,{replace:!0,locationId:`${l}-entry`,loop:!1})),o.backgroundMusic&&(console.log(`RUN #${a}: Playing combat BGM ${o.backgroundMusic}`),b(o.backgroundMusic,{replace:!0,locationId:`${l}-bgm`,loop:!0})),console.log(`RUN #${a}: Initialization block finished.`)}else o?c&&console.log(`RUN #${a}: SKIPPED audio init (already initialized for combat ID: ${o.id})`):console.log(`RUN #${a}: SKIPPED audio init (combat object not found for ID: ${x})`);return()=>{if(!x)return;if(console.log(`useCombatSession AUDIO EFFECT CLEANUP #${a} for combat ID: ${x}`),new URLSearchParams(window.location.search).get("id")!==x){const P=`combat-${x}`;console.log(`CLEANUP #${a}: Cleaning up audio for ${P}`),g(P),O(x)}else console.log(`CLEANUP #${a}: Skipped cleanup (not actually leaving combat)`)}},[x,b,g]),d.useEffect(()=>{I&&u()},[I]);const T=h[M],V=h.find(a=>a.id===($||(T==null?void 0:T.id)));d.useEffect(()=>{T&&!$&&W(T.id)},[T,$]);const u=()=>{if(!I)return;const a=I.playerCharacters.map(c=>{const l=m.find(E=>E.id===c.id);return l?{id:`pc-${l.id}-${Math.random().toString(36).substring(2,9)}`,character:l,initiative:0,currentHp:l.hp||10,maxHp:l.hp||10,notes:"",isPlayerCharacter:!0}:null}).filter(Boolean),N=I.enemies.map(c=>{const l=m.find(E=>E.id===c.id);return l?{id:`enemy-${l.id}-${Math.random().toString(36).substring(2,9)}`,character:l,initiative:Math.floor(Math.random()*20)+1,currentHp:l.hp||10,maxHp:l.hp||10,notes:"",isPlayerCharacter:!1}:null}).filter(Boolean),o=[...a,...N].sort((c,l)=>l.initiative-c.initiative);A(o),y(0),i(1)};return{combat:I,participants:h,currentTurnIndex:M,currentParticipant:T,selectedParticipant:V,selectedParticipantId:$,round:B,editingParticipantId:C,handleClose:()=>{s("/combats")},nextTurn:()=>{if(h.length===0)return;const a=(M+1)%h.length;y(a),W(h[a].id),a===0&&i(N=>N+1)},addParticipant:(a,N,o)=>{var F;const c=m.find(p=>p.id===a);if(!c)return;const l={id:`${o?"pc":"enemy"}-${c.id}-${Math.random().toString(36).substring(2,9)}`,character:c,initiative:N,currentHp:c.hp||10,maxHp:c.hp||10,notes:"",isPlayerCharacter:o},E=[...h,l].sort((p,K)=>K.initiative-p.initiative);A(E);const P=((F=h[M])==null?void 0:F.initiative)||0;if(N>P){const p=E.findIndex(K=>K.id===l.id);y(p),W(l.id)}return l},updateInitiative:(a,N)=>{var F;console.log(`useCombatSession.updateInitiative called for ID ${a} with value ${N}`);const o=h.find(p=>p.id===a);if(!o){console.error(`Participant with ID ${a} not found!`);return}console.log(`Found participant: ${o.character.name}, current initiative: ${o.initiative}`);const c=JSON.parse(JSON.stringify(h));for(let p=0;p<c.length;p++)c[p].id===a&&(console.log(`Updating ${c[p].character.name} initiative from ${c[p].initiative} to ${N}`),c[p].initiative=N);const l=c.sort((p,K)=>K.initiative-p.initiative),E=(F=h[M])==null?void 0:F.id,P=l.findIndex(p=>p.id===E);console.log("Before update:",h.map(p=>`${p.character.name}: ${p.initiative}`)),console.log("After update:",l.map(p=>`${p.character.name}: ${p.initiative}`)),A(l),y(P>=0?P:0)},updateMultipleInitiatives:a=>{var E;console.log("Updating multiple initiatives at once:",a);const N=JSON.parse(JSON.stringify(h));a.forEach(P=>{const F=N.findIndex(p=>p.id===P.id);if(F!==-1){const p=N[F];console.log(`Bulk update: ${p.character.name} initiative from ${p.initiative} to ${P.initiative}`),N[F].initiative=P.initiative}});const o=N.sort((P,F)=>F.initiative-P.initiative),c=(E=h[M])==null?void 0:E.id,l=o.findIndex(P=>P.id===c);console.log("Before bulk update:",h.map(P=>`${P.character.name}: ${P.initiative}`)),console.log("After bulk update:",o.map(P=>`${P.character.name}: ${P.initiative}`)),A(o),y(l>=0?l:0)},updateHp:(a,N)=>{const o=h.map(c=>c.id===a?{...c,currentHp:N,isDefeated:N<=0}:c);A(o)},updateNotes:(a,N)=>{const o=h.map(c=>c.id===a?{...c,notes:N}:c);A(o)},removeParticipant:a=>{var c,l;if($===a){const E=(c=h[M])==null?void 0:c.id;W(E!==a?E:null)}const N=((l=h[M])==null?void 0:l.id)===a,o=h.filter(E=>E.id!==a);N&&M>=o.length&&y(0),A(o)},selectParticipant:a=>{W(a)},setEditingParticipantId:j}},Fe=()=>e.jsxs("svg",{xmlns:"http://www.w3.org/2000/svg",width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",className:"inline-block",children:[e.jsx("line",{x1:"5",y1:"12",x2:"19",y2:"12"}),e.jsx("polyline",{points:"12 5 19 12 12 19"})]}),We=()=>{const{combat:s,participants:v,currentTurnIndex:w,currentParticipant:m,selectedParticipant:t,selectedParticipantId:U,round:O,editingParticipantId:b,handleClose:g,nextTurn:S,addParticipant:x,updateInitiative:I,updateMultipleInitiatives:h,updateHp:A,updateNotes:M,removeParticipant:y,selectParticipant:B,setEditingParticipantId:i}=be(),[C,j]=d.useState(!1),$=Y(n=>n.characters),[W,q]=d.useState(!1),[T,V]=d.useState(null),[u,D]=d.useState(!1),[L,R]=d.useState(""),[z,se]=d.useState(""),[de,ae]=d.useState(!1),[me,ue]=d.useState(""),[a,N]=d.useState(!1),[o,c]=d.useState(""),[l,E]=d.useState(""),P=n=>{ue(n),ae(!0)},F=(n,f)=>{c(n),E(f),N(!0)},p=()=>{ae(!1),N(!1)},K=n=>{if(!n)return;const f=n.character;f.descriptionType==="pdf"&&f.descriptionAssetName||f.descriptionType==="image"&&f.descriptionAssetName?P(f.descriptionAssetName):F(f.description||"",f.name)},xe=()=>{if(!t||!L)return;const n=parseInt(L);if(isNaN(n))return;const f=L.startsWith("+")||L.startsWith("-")?t.currentHp+n:n;A(t.id,Math.max(0,Math.min(f,t.maxHp))),R("")},he=()=>{if(!t||!z)return;const n=t.notes?`${t.notes}
${z}`:z;M(t.id,n),se("")},ge=(n,f)=>{var Z;if(!t)return;const G=(((Z=t.notes)==null?void 0:Z.split(`
`))||[]).filter(ie=>ie!==f).join(`
`);M(n,G)},pe=n=>{R(n),setTimeout(()=>{const f=document.getElementById("quickHpInput");f&&(f.focus(),f.setSelectionRange(n.length,n.length))},50)};d.useEffect(()=>{s&&v.length>0&&!u&&(v.some(f=>f.initiative===0)?q(!0):D(!0))},[s,v,u]);const je=n=>{if(console.log("Received updated participants with initiatives:",n.map(f=>`${f.character.name}: ${f.initiative}`)),T){const f=n[0];console.log(`Adding new participant ${T.character.name} with initiative ${f.initiative}`);const J=x(T.character.id,f.initiative,T.isPlayerCharacter);console.log("Add participant result:",J!=null&&J.id?"Success":"Failed")}else{const f=n.map(J=>({id:J.id,initiative:J.initiative}));h(f)}q(!1),D(!0),V(null)},Ne=(n,f,J)=>{const G=$.find(ie=>ie.id===n);if(!G)return;const Z={id:`${J?"pc":"enemy"}-${G.id}-${Math.random().toString(36).substring(2,9)}`,character:G,initiative:0,currentHp:G.hp||10,maxHp:G.hp||10,notes:"",isPlayerCharacter:J};V(Z),j(!1),q(!0)};return s?e.jsxs("div",{className:"h-full flex flex-col overflow-hidden",children:[e.jsx("div",{className:"glass-effect border-b border-border-DEFAULT/20 px-3 py-2",children:e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("div",{className:"flex items-center",children:[e.jsx(te,{"aria-label":"Back",onClick:g,className:"mr-2 p-1",children:e.jsx(Ae,{className:"w-4 h-4 text-primary-light"})}),e.jsx("h1",{className:"font-display font-semibold text-base bg-gradient-to-r from-primary-light to-secondary-light bg-clip-text text-transparent truncate",children:s.name||"Untitled Combat"})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(fe,{label:`Round ${O}`,color:"primary",variant:"outlined",className:"text-xs py-0.5 px-2"}),m&&e.jsx("div",{className:"flex items-center",children:e.jsxs(r,{variant:"body2",className:"mr-2 text-sm",children:["Current Turn: ",e.jsx("span",{className:"font-semibold",children:m.character.name})]})}),e.jsx(k,{variant:"contained",color:"primary",onPress:S,endIcon:e.jsx(Fe,{}),isDisabled:v.length===0,className:"text-xs py-1 px-2",children:"Next Turn"}),e.jsx(k,{variant:"outlined",color:"primary",size:"small",onPress:()=>j(!0),className:"text-xs py-0.5 px-2 min-w-0",children:"Add Participant"})]})]})}),e.jsxs("div",{className:"flex flex-1 overflow-hidden",children:[e.jsxs("div",{className:"w-1/4 flex-shrink-0 border-r border-border-DEFAULT/20 flex flex-col overflow-hidden",children:[e.jsx("div",{className:"bg-background-surface/30 px-3 py-2 border-b border-border-DEFAULT/20",children:e.jsx("h2",{className:"font-display font-medium text-sm text-text-primary",children:"Initiative Order"})}),e.jsx("div",{className:"flex-grow overflow-auto",children:v.length>0?e.jsx(Re,{participants:v,currentTurnIndex:w,selectedParticipantId:U,onSelectParticipant:B}):e.jsx("div",{className:"text-center p-3",children:e.jsx("p",{className:"text-xs text-text-secondary",children:"No participants yet"})})})]}),e.jsxs("div",{className:"w-1/4 flex-shrink-0 border-r border-border-DEFAULT/20 flex flex-col overflow-hidden",children:[e.jsx("div",{className:"bg-background-surface/30 px-3 py-2 border-b border-border-DEFAULT/20",children:e.jsx("h2",{className:"font-display font-medium text-sm text-text-primary",children:"Quick Actions"})}),m&&e.jsxs("div",{className:"p-3 flex flex-col gap-3 overflow-auto",children:[e.jsxs(Q,{className:"p-3",children:[e.jsxs(r,{variant:"subtitle2",className:"font-semibold mb-2 text-primary-light",children:["Current Turn: ",m.character.name]}),e.jsxs("div",{className:"grid grid-cols-2 gap-2 mb-3",children:[e.jsxs("div",{className:"bg-background-surface/30 p-2 rounded",children:[e.jsx(r,{variant:"caption",className:"block text-text-secondary",children:"HP"}),e.jsxs(r,{variant:"body1",className:"font-semibold",children:[m.currentHp," / ",m.maxHp]})]}),e.jsxs("div",{className:"bg-background-surface/30 p-2 rounded",children:[e.jsx(r,{variant:"caption",className:"block text-text-secondary",children:"Type"}),e.jsx(r,{variant:"body1",className:"font-semibold",children:m.isPlayerCharacter?"Player":m.character.type||"Enemy"})]})]}),e.jsx(k,{variant:"contained",color:"primary",onPress:()=>K(m),className:"text-xs py-1 w-full",children:"View Character Sheet"})]}),t&&e.jsxs(e.Fragment,{children:[e.jsxs(Q,{className:"p-3",children:[e.jsxs(r,{variant:"subtitle2",className:"font-semibold mb-2",children:["Modify HP for ",t.character.name]}),e.jsxs("div",{className:"flex gap-1 mb-3",children:[e.jsx(ce,{title:"Deal Damage",children:e.jsx(k,{variant:"outlined",color:"error",className:"flex-1 text-xs",onPress:()=>{pe("-")},children:"Damage"})}),e.jsx(ce,{title:"Heal",children:e.jsx(k,{variant:"outlined",color:"success",className:"flex-1 text-xs",onPress:()=>{pe("+")},children:"Heal"})})]}),e.jsxs("div",{className:"flex gap-1",children:[e.jsx(_,{id:"quickHpInput",value:L,onChange:n=>R(n),placeholder:"e.g. -5, +10, or 25",size:"small",className:"flex-1",onKeyDown:n=>{n.key==="Enter"&&xe()}}),e.jsx(k,{variant:"contained",color:"primary",onPress:xe,isDisabled:!L,className:"text-xs",children:"Apply"})]})]}),e.jsxs(Q,{className:"p-3",children:[e.jsx(r,{variant:"subtitle2",className:"font-semibold mb-2",children:"Add Notes"}),e.jsx(_,{value:z,onChange:n=>se(n),placeholder:"Quick notes...",size:"small",multiline:!0,rows:2,fullWidth:!0,className:"mb-2",onKeyDown:n=>{n.key==="Enter"&&n.ctrlKey&&he()}}),e.jsx(k,{variant:"contained",color:"primary",onPress:he,isDisabled:!z,className:"text-xs w-full mb-3",children:"Add Note"}),(t==null?void 0:t.notes)&&e.jsxs("div",{className:"mt-2",children:[e.jsx(r,{variant:"caption",className:"block text-text-secondary mb-1",children:"Existing Notes:"}),e.jsx("div",{className:"max-h-40 overflow-y-auto bg-background-surface/30 rounded p-2",children:t.notes.split(`
`).filter(n=>n.trim()).map((n,f)=>e.jsxs("div",{className:"flex justify-between items-center py-1 px-1 rounded mb-1 hover:bg-background-surface group",children:[e.jsx(r,{variant:"body2",className:"text-xs break-words flex-grow mr-2",children:n}),e.jsx(te,{onClick:()=>ge(t.id,n),"aria-label":"Remove note",className:"opacity-0 group-hover:opacity-100 transition-opacity p-0.5",children:e.jsxs("svg",{xmlns:"http://www.w3.org/2000/svg",width:"14",height:"14",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",className:"text-red-500",children:[e.jsx("line",{x1:"18",y1:"6",x2:"6",y2:"18"}),e.jsx("line",{x1:"6",y1:"6",x2:"18",y2:"18"})]})})]},f))})]})]})]})]}),!m&&e.jsx("div",{className:"flex items-center justify-center h-full",children:e.jsx(r,{variant:"body2",className:"text-text-secondary",children:"Start combat to activate quick actions"})})]}),e.jsx("div",{className:"flex-grow overflow-hidden",children:t?e.jsx(Oe,{participant:t,onUpdateHp:A,onUpdateNotes:M,onRemoveParticipant:y,onUpdateInitiative:I,isEditing:b===t.id,onSetEditing:n=>i(n?t.id:null),onViewDescription:()=>K(t)}):e.jsx("div",{className:"h-full flex items-center justify-center",children:e.jsxs("div",{className:"text-center px-4 py-6",children:[e.jsx("div",{className:"text-primary-light/50 mb-1",children:e.jsxs("svg",{xmlns:"http://www.w3.org/2000/svg",width:"32",height:"32",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",className:"mx-auto",children:[e.jsx("path",{d:"M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"}),e.jsx("circle",{cx:"12",cy:"7",r:"4"})]})}),e.jsx("p",{className:"text-sm text-text-secondary",children:"Select a participant"})]})})})]}),e.jsx(Ue,{open:C,onClose:()=>j(!1),onAddParticipant:Ne,characters:$}),e.jsx(ze,{open:W,onClose:()=>{T&&V(null),q(!1)},participants:T?[T]:v,onComplete:je,isSingleParticipant:!!T,title:T?"Set Initiative for New Participant":"Set Initiative",onViewCharacterDetails:K}),e.jsx(Te,{pdfViewerOpen:de,markdownDialogOpen:a,currentPdfAsset:me,currentMarkdownContent:o,currentMarkdownTitle:l,onClose:p})]}):e.jsx("div",{className:"max-w-full h-full p-2",children:e.jsxs("div",{className:"glass-effect rounded-lg p-4 text-center",children:[e.jsx(r,{variant:"h5",className:"font-display text-base font-semibold",children:"Combat not found"}),e.jsx(k,{variant:"contained",color:"primary",onPress:g,className:"mt-2 text-sm py-1",children:"Back to Combat List"})]})})},Ze=()=>{const{combat:s,handleClose:v}=be();return s?e.jsxs("div",{className:"p-6",children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsxs(r,{variant:"h4",component:"h1",className:"text-gray-100",children:["Combat: ",s.name]}),e.jsx(k,{onPress:v,variant:"outlined",color:"secondary",children:"Exit Without Saving"})]}),e.jsx(H,{className:"bg-gray-800/50 p-4 rounded-lg mb-6",children:e.jsx(ve,{content:s.description||"*No description provided*"})}),e.jsx(H,{className:"bg-gray-800 p-4 rounded-lg",children:e.jsx(We,{})})]}):e.jsxs(H,{className:"p-8 text-center",children:[e.jsx(r,{variant:"h5",className:"mb-4",children:"Combat session not found"}),e.jsx(k,{variant:"contained",color:"primary",onPress:v,children:"Back to Combat List"})]})};export{Ze as CombatSessionView};
//# sourceMappingURL=CombatSessionView-D_gu0F6f.js.map
